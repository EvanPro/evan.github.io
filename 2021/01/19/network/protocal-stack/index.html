<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Evan">



    <meta name="description" content="少年书生志气宏">



<title>协议栈 | Evan&#39;s Blog</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.3.0"></head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">Evan&#39;s Blog</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">文章</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">Evan&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">文章</a>
                
                    <a class="menu-item" href="/category">分类</a>
                
                    <a class="menu-item" href="/tag">标签</a>
                
                    <a class="menu-item" href="/about">关于</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    
        <div class="post-toc">
    <div class="tocbot-list">
    </div>
    <div class="tocbot-list-menu">
        <a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a>
        <a onclick="go_top()">Back to top</a>
        <a onclick="go_bottom()">Go to bottom</a>
    </div>
</div>

<script>
    document.ready(
        function () {
            tocbot.init({
                tocSelector: '.tocbot-list',
                contentSelector: '.post-content',
                headingSelector: 'h1, h2, h3, h4, h5',
                collapseDepth: 1,
                orderedList: false,
                scrollSmooth: true,
            })
        }
    )

    function expand_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 6,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "collapse_toc()");
        b.innerHTML = "Collapse all"
    }

    function collapse_toc() {
        var b = document.querySelector(".tocbot-toc-expand");
        tocbot.init({
            tocSelector: '.tocbot-list',
            contentSelector: '.post-content',
            headingSelector: 'h1, h2, h3, h4, h5',
            collapseDepth: 1,
            orderedList: false,
            scrollSmooth: true,
        });
        b.setAttribute("onclick", "expand_toc()");
        b.innerHTML = "Expand all"
    }

    function go_top() {
        window.scrollTo(0, 0);
    }

    function go_bottom() {
        window.scrollTo(0, document.body.scrollHeight);
    }

</script>
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">协议栈</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        发表于: <a href="#">一月 19, 2021</a>
                        </span>
                    
                    
                        <span class="post-category">
                    分类于:
                            
                                <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>
                            
                        </span>
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>网络软件的数据收发是通过委托给操作系统的网络控制软件（协议栈）以及硬件网卡来实现的。<br>协议栈是一组网络协议的具体实现，OSI七层模型和TCP/IP五层模型的对比如下：</p>
<img src="/2021/01/19/network/protocal-stack/protocol_stack.png" class="">

<h2 id="套接字"><a href="#套接字" class="headerlink" title="套接字"></a>套接字</h2><p>在协议栈内部有一块用于存放控制信息的内存空间，这里记录了用于控制通信操作的控制信息，例如通信对象的IP地址、端口号、通信操作的进行状态等。本来套接字就只是一个概念而已，并不存在实体，如果一定要赋予它一个实体，我们可以说这些控制信息就是套接字的实体，或者说存放控制信息的内存空间就是套接字的实体。<strong>协议栈是根据套接字中记录的信息来工作的。</strong></p>
<h2 id="协议栈TCP通信过程"><a href="#协议栈TCP通信过程" class="headerlink" title="协议栈TCP通信过程"></a>协议栈TCP通信过程</h2><ol>
<li>创建套接字：分配一个套接字所需的内存空间，向其写入初始状态，将表示这个套接字的<strong>描述符</strong>告知应用程序。</li>
<li>连接</li>
<li>收发数据</li>
<li>断开：套接字会被删除</li>
</ol>
<h3 id="连接阶段"><a href="#连接阶段" class="headerlink" title="连接阶段"></a>连接阶段</h3><p>连接实际上是通信双方交换控制信息，在套接字中记录这些必要信息并准备数据收发的一连串操作。此外，当执行数据收发操作时，我们还需要一块用来临时存放要手法的数据的内存空间，这块内存称为缓冲区，它也是在连接操作的过程中分配的。连接阶段也可以叫做准备阶段。</p>
<p>这个过程是从应用程序调用Socket库的connect方法开始的，需要指定<strong>描述符</strong>、<strong>服务器IP地址</strong>和<strong>端口号</strong>这三个参数。<br>其实就是TCP三次握手的过程。</p>
<h4 id="负责保存信息的头部"><a href="#负责保存信息的头部" class="headerlink" title="负责保存信息的头部"></a>负责保存信息的头部</h4><p>通信操作中使用的控制信息分为两类：</p>
<ol>
<li>头部中记录的信息</li>
<li>套接字（协议栈中的内存空间）中记录的信息</li>
</ol>
<p>TCP头部包含收发方端口号、控制位、窗口等字段，而套接字的控制信息和协议栈的程序本身其实是一体的，因此，“协议栈具体需要哪些信息”会根据协议栈本身的实现方式不同而不同，协议栈中的控制信息通信对方是看不见的，只要在通信时按照规则将必要的信息写入头部、客户端和服务器之间的通信就得以成立。因此不同的操作系统直接可以通信。</p>
<h3 id="收发数据"><a href="#收发数据" class="headerlink" title="收发数据"></a>收发数据</h3><p>当控制流程从connect回到应用程序之后，接下来就进入了数据收发阶段了。应用程序调用write将要发送的数据交给协议栈，应用程序在调用write时会指定收发数据的长度。协议栈并不是一收到数据就马上发送出去，而是会将数据存放在内部的<strong>发送缓冲区</strong>中，并等待应用程序的下一段数据。这样做时有意义的，应用程序交给协议栈的数据长度是由应用程序自己决定的，有的一次传递所有数据，有的逐字节或者逐行传递，协议栈无法控制这些行为。如果协议栈一收到数据就马上发送出去可能会发送大量的小包，造成网络效率低下，因此需要积累一定量的数据再发送。至于积累多少再发送，不同的操作系统实现也不一致。一般都会根据几个要素判断：</p>
<ol>
<li>每个网络包能容纳的数据长度：当应用程序收到的数据长度超过或者接近MSS（最大分段大小）时再发送，可以避免大量小包的问题。</li>
<li>事件：当应用程序发送数据的频率不高的时候，如果每次都等到长度接近MSS时再发送，可能会因为等待时间太长而造成延迟。协议栈内部有一个计时器，当经过一定时间之后，就会把网络包发出去。</li>
</ol>
<p>这两个要素时互相矛盾的，因此怎样才能达到平衡是由协议栈开发者来决定的。同时，如果仅靠协议栈来判断发送时机可能会带来一些问题，因此协议栈也给应用程序保留了控制发送时机的余地，提供了一些控制选项。</p>
<p>//todo: TCP 慢启动、可靠传输</p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>标签:</span>
                <span class="tag">
                    
                    
                        <a href="/tags/TCP/"># TCP</a>
                    
                        
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">返回</a>
                <span>· </span>
                <a href="/">首页</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/01/31/network/tcp/">TCP协议</a>
            
            
            <a class="next" rel="next" href="/2020/10/17/springboot/annotation/">Spring 注解驱动设计模式</a>
            
        </section>


    </article>
</div>

        </div>
        <!-- <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Evan | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span>
    </div>
</footer>
 -->
    </div>
</body>
</html>
